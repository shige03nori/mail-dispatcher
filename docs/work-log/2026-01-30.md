# 作業ログ 2026-01-30

## 今日のゴール

- 業務SaaSとして成立する認証・ユーザー管理基盤の完成

---

## 実装内容

### 1. Magic Link ログイン

- パスワードレス認証を実装
- ワンタイムトークン方式（URLに生トークン、DBにはハッシュ）
- 有効期限・使い捨て制御あり
- Prisma + Next.js App Router で構築

### 2. セッション管理

- 署名付きセッションCookieを自前実装
- userId / organizationId / role / 有効期限を保持
- HMAC署名による改ざん防止
- cookies() Promise化への対応

### 3. ダッシュボード

- 認証済みユーザーのみアクセス可能
- 未ログイン時は /login へリダイレクト
- 組織・ユーザー・ロール情報を表示

### 4. ログアウト

- /api/auth/logout 実装
- セッションCookie削除
- ログアウト後は /login へ遷移

### 5. ユーザー招待機能（Admin限定）

- 招待リンク発行（24時間有効・使い捨て）
- Role指定（VIEWER / EDITOR）
- 招待受諾時に User / Membership 作成
- 受諾後は自動ログイン

---

## 技術的な学び・ハマりどころ

- Next.js Route Handler は default export 不可
- cookies() は Promise を返すため await が必須
- SESSION_SECRET 未設定による 500 エラー対応
- Windows × TypeScript の大文字小文字キャッシュ問題
  - ファイルを一度リネームして解消
- React.FormEvent 非推奨警告
  - React.SyntheticEvent に変更して対応
- 招待リンクは 1 回利用で無効（仕様通り）

---

## 今日の成果

- 認証・権限・ユーザー管理まで実装完了
- 社内利用を前提としたSaaS基盤が完成

---

## 次回やること

- 連絡先（Contact）CRUD の実装
