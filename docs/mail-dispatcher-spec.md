# メール送信支援システム 仕様書（完全版）

※ 本書は「招待制 + Magic Link 認証（SSO後付け可能）」を前提とした仕様書です。

---

## 1. 目的

案件情報・人材情報を効率よく拡散し、以下を実現する。

- 案件に対する人材募集（案件拡散）
- 人材に対する案件紹介依頼（人材拡散）
- 誤送信・重複送信・配信停止漏れの防止
- 誰が・いつ・誰に・何を送ったかの監査性確保

---

## 2. 想定利用者

- 会社内ユーザー
  - Admin（管理者）
  - Editor（運用者）
  - Viewer（閲覧者）

---

## 3. システム概要

- 方式：Webアプリ（PCブラウザ）
- フロントエンド：Next.js + TypeScript
- UI：Tailwind CSS + shadcn/ui
- DB：SQLite（開発）/ PostgreSQL（本番想定）
- ORM：Prisma
- メール送信：SMTP または SendGrid 等
- 非同期処理：BullMQ + Redis（後続フェーズ）

---

## 4. 認証・認可

### 4.1 認証方式

- 招待制（公開登録不可）
- Magic Link によるログイン
  - メールアドレス入力 → ワンタイムリンク送信
  - 有効期限：15分
  - トークンは1回限り

### 4.2 ロール定義

| ロール | 権限                 |
| ------ | -------------------- |
| Admin  | ユーザー管理、全操作 |
| Editor | 作成・送信・履歴閲覧 |
| Viewer | 閲覧のみ             |

### 4.3 将来のSSO対応

- Auth.js を利用し Google / Microsoft SSO を後付け可能
- User / Organization / Role の構造は変更不要

---

## 5. 組織・データ分離

- 全データに organizationId を付与
- 他組織データへのアクセスは禁止

---

## 6. 機能一覧（MVP）

- ユーザー招待・無効化
- 連絡先管理（CRUD・検索・複数選択）
- テンプレート管理（変数差し込み）
- キャンペーン作成（案件/人材）
- メールプレビュー
- 1通ずつ個別送信
- 配信停止（opt-out）
- 重複送信防止
- 送信履歴管理

---

## 7. 変数差し込み仕様

- 記法：{{name}}, {{company}} 等
- 未設定時：警告表示、送信は可（MVP）

---

## 8. 送信仕様

- To：1件のみ
- Cc/Bcc：対象外
- 送信単位：宛先1件 = メール1通
- テスト送信機能あり

---

## 9. 安全設計

- 配信停止は自動除外（SKIPPEDとして記録）
- 同一キャンペーン + 同一宛先は再送不可
- 送信前プレビュー必須
- 本文最終形をDB保存

---

## 10. 監査・ログ

- 送信履歴（必須）
- 操作ログ（次フェーズ）

---

## 11. 非機能要件

- 環境変数による秘密情報管理
- 型安全なDBアクセス（Prisma）
- 監査性・保守性・拡張性を重視

---

## 12. 完成判定（MVP）

- 招待ユーザーがログイン可能
- ロール制御が有効
- メール作成〜送信〜履歴確認が一連で可能
- 誤送信防止が機能している

---
