// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

/**
 * =========================
 * Enums
 * =========================
 */

enum UserStatus {
  INVITED
  ACTIVE
  DISABLED
}

enum Role {
  ADMIN
  EDITOR
  VIEWER
}

enum CampaignType {
  JOB
  TALENT
}

enum SendStatus {
  SUCCESS
  FAILED
  SKIPPED
}

enum CampaignStatus {
  DRAFT
  SENDING
  SENT
  FAILED
}

enum RecipientStatus {
  PENDING
  SENT
  FAILED
  SKIPPED
}

/**
 * =========================
 * Core: Organization / User / Membership
 * =========================
 */

model Organization {
  id        String   @id @default(uuid())
  name      String   @unique
  domain    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members        Membership[]
  invitations    Invitation[]
  contacts       Contact[]
  templates      Template[]
  campaigns      Campaign[]
  sendHistory    SendHistory[]
  settings       OrganizationSetting?
  auditLogs      AuditLog[]
  emailTemplates EmailTemplate[]
  emailCampaigns EmailCampaign[]

  @@index([domain])
}

model User {
  id        String     @id @default(uuid())
  email     String     @unique
  name      String?
  status    UserStatus @default(INVITED)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  memberships        Membership[]
  createdInvitations Invitation[] @relation("InvitationCreatedBy")
  loginTokens        LoginToken[]

  createdContacts  Contact[]  @relation("ContactCreatedBy")
  updatedContacts  Contact[]  @relation("ContactUpdatedBy")
  createdTemplates Template[] @relation("TemplateCreatedBy")
  updatedTemplates Template[] @relation("TemplateUpdatedBy")
  createdCampaigns Campaign[] @relation("CampaignCreatedBy")

  sendHistorySentBy SendHistory[]   @relation("SendHistorySentBy")
  auditLogs         AuditLog[]
  emailTemplates    EmailTemplate[]
  emailCampaigns    EmailCampaign[]

  templatesCreated EmailTemplate[] @relation("EmailTemplateCreatedBy")
  templatesUpdated EmailTemplate[] @relation("EmailTemplateUpdatedBy")
  campaignsCreated EmailCampaign[] @relation("EmailCampaignCreatedBy")
}

model Membership {
  id             String   @id @default(uuid())
  organizationId String
  userId         String
  role           Role     @default(VIEWER)
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([userId])
}

/**
 * =========================
 * Invitation (招待制)
 * =========================
 */

model Invitation {
  id             String @id @default(uuid())
  organizationId String
  email          String
  role           Role   @default(VIEWER)

  tokenHash  String    @unique
  expiresAt  DateTime
  acceptedAt DateTime?

  createdByUserId String
  createdAt       DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User         @relation("InvitationCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)

  @@index([organizationId])
  @@index([email])
}

/**
 * =========================
 * LoginToken (Magic Link)
 * =========================
 */

model LoginToken {
  id        String    @id @default(uuid())
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

/**
 * =========================
 * Business
 * =========================
 */

model Contact {
  id             String @id @default(uuid())
  organizationId String

  name        String
  companyName String?
  email       String?
  phone       String?

  note String?

  createdByUserId String
  updatedByUserId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User         @relation("ContactCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)
  updatedBy    User?        @relation("ContactUpdatedBy", fields: [updatedByUserId], references: [id], onDelete: SetNull)

  sendHistory        SendHistory[]
  campaignRecipients EmailCampaignRecipient[]

  @@index([organizationId])
  @@index([email])
  @@index([phone])
  @@index([companyName])
}

model Template {
  id             String @id @default(uuid())
  organizationId String

  name          String
  subject       String
  body          String
  variablesJson String?

  createdByUserId String
  updatedByUserId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User         @relation("TemplateCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)
  updatedBy    User?        @relation("TemplateUpdatedBy", fields: [updatedByUserId], references: [id], onDelete: SetNull)

  campaigns Campaign[]

  @@index([organizationId])
}

model Campaign {
  id             String         @id @default(uuid())
  organizationId String
  type           CampaignType
  name           String
  description    String?
  status         CampaignStatus @default(DRAFT)

  templateId      String
  createdByUserId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  template     Template     @relation(fields: [templateId], references: [id], onDelete: Restrict)
  createdBy    User         @relation("CampaignCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)

  sendHistory SendHistory[]

  @@index([organizationId])
  @@index([templateId])
}

model SendHistory {
  id             String @id @default(uuid())
  organizationId String

  campaignId String
  contactId  String

  toEmail      String
  subjectFinal String
  bodyFinal    String

  status       SendStatus
  errorMessage String?
  sentAt       DateTime?
  isTest       Boolean    @default(false)

  sentByUserId String?

  createdAt DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  campaign     Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact      Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  sentBy       User?        @relation("SendHistorySentBy", fields: [sentByUserId], references: [id], onDelete: SetNull)

  @@unique([organizationId, campaignId, contactId])
  @@index([organizationId])
  @@index([campaignId])
  @@index([contactId])
}

model OrganizationSetting {
  id             String @id @default(uuid())
  organizationId String @unique

  mailFromAddress String?
  mailFromName    String?
  replyToAddress  String?
  signature       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id             String  @id @default(uuid())
  organizationId String
  actorUserId    String?

  action     String
  targetType String?
  targetId   String?
  beforeJson String?
  afterJson  String?

  createdAt DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  actor        User?        @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([actorUserId])
  @@index([action])
}

model EmailTemplate {
  id             String  @id @default(cuid())
  organizationId String
  name           String
  subject        String
  textBody       String
  htmlBody       String?
  isArchived     Boolean @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdByUserId String
  updatedByUserId String

  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdByUser User         @relation("EmailTemplateCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)
  updatedByUser User         @relation("EmailTemplateUpdatedBy", fields: [updatedByUserId], references: [id], onDelete: Restrict)

  campaigns EmailCampaign[]
  user      User?           @relation(fields: [userId], references: [id])
  userId    String?

  @@unique([organizationId, name])
  @@index([organizationId, isArchived, updatedAt])
}

model EmailCampaign {
  id             String @id @default(cuid())
  organizationId String

  templateId           String?
  templateNameSnapshot String?
  subjectSnapshot      String
  textBodySnapshot     String
  htmlBodySnapshot     String?

  status CampaignStatus @default(DRAFT)

  totalCount   Int @default(0)
  sentCount    Int @default(0)
  failedCount  Int @default(0)
  skippedCount Int @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdByUserId String

  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdByUser User         @relation("EmailCampaignCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)

  template EmailTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  recipients EmailCampaignRecipient[]
  user       User?                    @relation(fields: [userId], references: [id])
  userId     String?

  @@index([organizationId, createdAt])
  @@index([organizationId, status, updatedAt])
}

model EmailCampaignRecipient {
  id         String  @id @default(cuid())
  campaignId String
  contactId  String?

  // 送信時点で使った宛先（Contactから拾って保存）
  emailSnapshot       String?
  // 名前差し込みなどに使うなら、必要最低限で snapshot を増やしてもOK
  contactNameSnapshot String?

  status       RecipientStatus @default(PENDING)
  errorMessage String?

  // メールプロバイダの messageId などを保存したければ
  providerMessageId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaign EmailCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact  Contact?      @relation(fields: [contactId], references: [id], onDelete: SetNull)

  @@index([campaignId, status, updatedAt])
  @@index([contactId])
  @@index([emailSnapshot])
}
